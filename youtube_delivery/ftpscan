#!/bin/bash

# This script is intended to scan a folder for newly uploaded files and then 
# upload those files to youtube automatically.

LOCK="/tmp/$(basename "${0}").lock"

dir="/Volumes/From library/youtube_delivery"
donedir="${dir}/Uploaded"
dupdir="${dir}/Duplicates"
errordir="${dir}/Errors"
logDir="/var/log/"
UPLOADED_MD5S="/Users/cunytvadmin/uploaded.hash"
ytErr="/tmp/youtube-upload2.stderr"

logit(){
  MSG="${1}"
  WHEN="$(date +%FT%T)"
  logFile="${logDir}/ftpscan.log"
  echo "${WHEN}: ${MSG}" >> "$logFile"
}

if [[ -f "$LOCK" ]] ; then
  "$0 is already running, remove the $LOCK file is you need to reset"
else
  touch "$LOCK"
  # Get the current file list from the directory
  find "${dir}" -type f -name "*.mp4" -maxdepth 1 -mindepth 1 | while read file ; do
    echo "getting checksum for $file"
    FILE_MD5="$(md5 -q "${file}")"
    FILE_NAME="$(basename "${file}")"
    if [[ "$(grep "${FILE_MD5}" "${UPLOADED_MD5S}")" ]] ; then
      logit "${FILE_NAME} is already uploaded, according to md5 match (${FILE_MD5})."
      mv -v "${file}" "${dupdir}"
    else
      echo "Trying to upload ${file} to youtube"
      YOUTUBE_ID="$(/usr/local/bin/youtube-upload --client-secrets="/Library/Frameworks/Python.framework/Versions/2.7/share/youtube_upload/client_secrets.json" --credentials-file="/Users/cunytvadmin/.youtube-upload-credentials.json" --title="$(basename "${file%.*}")" --privacy=private "${file}" 2>$ytErr)"
      echo "Outcome of uploading ${file} is ${YOUTUBE_ID}."
      if [[ "${#YOUTUBE_ID}" == 11 ]] ; then
        mv -v "${file}" "${donedir}"
        logit "${FILE_NAME} is uploaded, (${YOUTUBE_ID})."
        echo "${FILE_MD5}" >> "${UPLOADED_MD5S}"
      else
        mv -v "${file}" "${errordir}"
        logit "${FILE_NAME} had an error, see ${errordir}.stderr.txt."
        cat "${ytErr}" "${errordir}.stderr.txt"
      fi
    fi
  done
  if [[ -f "$LOCK" ]] ; then
	rm "$LOCK"
  fi
fi
